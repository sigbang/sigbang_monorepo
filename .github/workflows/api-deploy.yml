name: Deploy API

on:
  push:
    branches: [ main ]
    paths:
      - 'sigbang_api/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/sigbang_api-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare tags
        id: meta
        run: |
          SHA=${GITHUB_SHA::7}
          echo "image=${IMAGE_NAME}:${SHA}" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./sigbang_api
          file: ./sigbang_api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ steps.meta.outputs.image }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:latest
          cache-to: type=inline

  db-migrate-prod:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: sigbang_api
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            sigbang_api/package-lock.json
            package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run prisma migrate deploy to production (pooler)
        env:
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -eo pipefail
          if [ -z "${DIRECT_URL}" ]; then
            echo "ERROR: DIRECT_URL is not set." >&2
            exit 1
          fi          
          npx prisma migrate deploy --schema=./prisma/schema.prisma

  deploy-api-eic:
    needs: [build-and-push, db-migrate-prod]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Resolve image to deploy
        id: resolve
        run: |
          IMAGE_OUT="${{ needs.build-and-push.outputs.image }}"
          if [ -z "$IMAGE_OUT" ]; then
            IMAGE_OUT="${{ env.IMAGE_NAME }}:${{ github.sha }}"
          fi
          echo "image=$IMAGE_OUT" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      - name: Deploy API via SSM RunCommand (no SSH)
        env:
          IMAGE: ${{ steps.resolve.outputs.image }}
          AWS_REGION: ap-northeast-2
          TARGET_NAME_TAG: sigbang-api-api
          # Must match Terraform var.ssm_prefix (used by userdata.sh and SSM Parameter Store path)
          SSM_PREFIX: sigbang-api/production
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          CONTAINER_NAME: sigbang-api
          EXPOSE_PORT: "3000"
        run: |
          set -eo pipefail
          echo "Deploying to ALL instances with tag Name=${TARGET_NAME_TAG} (rolling via SSM)"
          cat >ssm-deploy-api.json <<EOF
          {
            "DocumentName": "AWS-RunShellScript",
            "Comment": "Deploy sigbang-api container via SSM",
            "Targets": [
              {
                "Key": "tag:Name",
                "Values": ["${TARGET_NAME_TAG}"]
              }
            ],
            "MaxConcurrency": "1",
            "MaxErrors": "0",
            "Parameters": {
              "commands": [
                "set -euo pipefail",
                "IMAGE='${IMAGE}'",
                "EXPOSE_PORT=${EXPOSE_PORT}",
                "CONTAINER_NAME='${CONTAINER_NAME}'",
                "ENV_FILE='/home/ubuntu/.env'",
                "AWS_REGION='${AWS_REGION}'",
                "SSM_PREFIX='${SSM_PREFIX}'",
                "echo \"[deploy-api-ssm] Refreshing env from SSM /$SSM_PREFIX\" | sudo tee -a /var/log/userdata.log >/dev/null || true",
                "sudo rm -f \\"$ENV_FILE\\" || true",
                "sudo touch \\"$ENV_FILE\\"",
                "aws ssm get-parameters-by-path --path \\"/$SSM_PREFIX\\" --with-decryption --recursive --region \\"$AWS_REGION\\" | jq -r '.Parameters // [] | .[] | [.Name, .Value] | @tsv' | while IFS=$'\\t' read -r name value; do key=$(basename \\"$name\\"); printf '%s=%s\\n' \\"$key\\" \\"$value\\" | sudo tee -a \\"$ENV_FILE\\" >/dev/null; done",
                "sudo chown ubuntu:ubuntu \\"$ENV_FILE\\" || true",
                "if echo \\"$IMAGE\\" | grep -q '^ghcr.io/' && [ -n '${GHCR_USERNAME}' ] && [ -n '${GHCR_TOKEN}' ]; then echo '${GHCR_TOKEN}' | sudo docker login ghcr.io -u '${GHCR_USERNAME}' --password-stdin || true; fi",
                "sudo docker system prune -af || true",
                "sudo docker pull \\"$IMAGE\\"",
                "sudo docker ps --filter \\"publish=$EXPOSE_PORT\\" -q | xargs -r sudo docker rm -f || true",
                "sudo docker rm -f \\"$CONTAINER_NAME\\" || true",
                "[ -f \\"$ENV_FILE\\" ] && ENV_FILE_ARG='--env-file $ENV_FILE' || ENV_FILE_ARG=''",
                "sudo docker run --pull=always -d --name \\"$CONTAINER_NAME\\" --restart=always $ENV_FILE_ARG -p $EXPOSE_PORT:3000 \\"$IMAGE\\"",
                "HEALTH_OK=0",
                "for i in {1..20}; do if curl -fsS http://localhost:$EXPOSE_PORT/health >/dev/null; then HEALTH_OK=1; break; fi; echo 'Health check failed ('\$i'/20), retrying in 3s...'; sleep 3; done",
                "if [ \\"$HEALTH_OK\\" -ne 1 ]; then echo 'Health check failed after retries. Showing recent container logs:'; sudo docker logs \\"$CONTAINER_NAME\\" || true; exit 1; fi",
                "sudo docker ps -a | sed -n '1p;/$CONTAINER_NAME/p'",
                "sudo docker inspect -f 'Image={{.Config.Image}} State={{.State.Status}}' $CONTAINER_NAME"
              ]
            }
          }
          EOF
          CMD_ID=$(aws ssm send-command \
            --cli-input-json file://ssm-deploy-api.json \
            --region "$AWS_REGION" \
            --query "Command.CommandId" \
            --output text)
          echo "SSM command sent. CommandId=$CMD_ID"


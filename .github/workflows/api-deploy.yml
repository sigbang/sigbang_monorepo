name: Deploy API

on:
  push:
    branches: [ main ]
    paths:
      - 'sigbang_api/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/sigbang_api-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare tags
        id: meta
        run: |
          SHA=${GITHUB_SHA::7}
          echo "image=${IMAGE_NAME}:${SHA}" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./sigbang_api
          file: ./sigbang_api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ steps.meta.outputs.image }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:latest
          cache-to: type=inline

  db-push-prod:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: sigbang_api
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            sigbang_api/package-lock.json
            package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run prisma db push to production (pooler)
        env:
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
        run: |
          set -eo pipefail
          if [ -z "${DIRECT_URL}" ]; then
            echo "ERROR: DIRECT_URL is not set." >&2
            exit 1
          fi
          DATABASE_URL: ${{ secrets.DATABASE_URL }}           
          npx prisma db push --schema=./prisma/schema.prisma

  deploy-api-eic:
    needs: [build-and-push, db-push-prod]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Resolve image to deploy
        id: resolve
        run: |
          IMAGE_OUT="${{ needs.build-and-push.outputs.image }}"
          if [ -z "$IMAGE_OUT" ]; then
            IMAGE_OUT="${{ env.IMAGE_NAME }}:${{ github.sha }}"
          fi
          echo "image=$IMAGE_OUT" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Deploy API via EC2 Instance Connect (SSH)
        env:
          IMAGE: ${{ steps.resolve.outputs.image }}
          AWS_REGION: ap-northeast-2
          # From Terraform: Name tag is "${var.project_name}-api" -> "sigbang-api-api"
          TARGET_NAME_TAG: sigbang-api-api
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          CONTAINER_NAME: sigbang-api
          EXPOSE_PORT: "3000"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -eo pipefail
          echo "Resolving API instance by tag Name=${TARGET_NAME_TAG}"
          IID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${TARGET_NAME_TAG}" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" --output text --region "$AWS_REGION")
          if [ -z "$IID" ]; then
            echo "No running instance found with Name=${TARGET_NAME_TAG}"
            exit 1
          fi
          AZ=$(aws ec2 describe-instances --instance-ids "$IID" \
            --query "Reservations[0].Instances[0].Placement.AvailabilityZone" --output text --region "$AWS_REGION")
          PUBIP=$(aws ec2 describe-instances --instance-ids "$IID" \
            --query "Reservations[0].Instances[0].PublicIpAddress" --output text --region "$AWS_REGION")
          echo "Target: $IID ($AZ) public-ip=$PUBIP"

          # EC2 Instance Connect: push one-time SSH key
          ssh-keygen -t ed25519 -N "" -f id_ed25519
          aws ec2-instance-connect send-ssh-public-key \
            --instance-id "$IID" --availability-zone "$AZ" \
            --instance-os-user ubuntu --ssh-public-key file://id_ed25519.pub \
            --region "$AWS_REGION" >/dev/null

          # Remote replacement of API container only (DB schema is managed via db-push-prod job)
          ssh -o ServerAliveInterval=10 -o ServerAliveCountMax=12 -o StrictHostKeyChecking=no -i id_ed25519 ubuntu@"$PUBIP" bash -lc "
            set -eo pipefail
            # Ensure git is available (for potential future use)
            command -v git >/dev/null || (sudo apt-get update -y && sudo apt-get install -y git curl)

            IMAGE='${IMAGE}'
            EXPOSE_PORT=${EXPOSE_PORT}
            CONTAINER_NAME='${CONTAINER_NAME}'
            if echo \"\$IMAGE\" | grep -q '^ghcr.io/' && [ -n '${GHCR_USERNAME}' ] && [ -n '${GHCR_TOKEN}' ]; then
              echo '${GHCR_TOKEN}' | sudo docker login ghcr.io -u '${GHCR_USERNAME}' --password-stdin || true
            fi
            ENV_FILE='/home/ubuntu/.env'
            sudo docker pull \"\$IMAGE\"
            sudo docker ps --filter \"publish=\$EXPOSE_PORT\" -q | xargs -r sudo docker rm -f || true
            sudo docker rm -f \"\$CONTAINER_NAME\" || true
            [ -f \"\$ENV_FILE\" ] && ENV_FILE_ARG='--env-file '\$ENV_FILE'' || ENV_FILE_ARG=''
            sudo docker run --pull=always -d --name \"\$CONTAINER_NAME\" --restart=always \$ENV_FILE_ARG -p \$EXPOSE_PORT:3000 \"\$IMAGE\"
            sleep 3
            curl -fsS http://localhost:\$EXPOSE_PORT/health >/dev/null
            sudo docker ps -a | sed -n '1p;/sigbang-api/p'
            sudo docker inspect -f 'Image={{.Config.Image}} State={{.State.Status}}' sigbang-api
          "


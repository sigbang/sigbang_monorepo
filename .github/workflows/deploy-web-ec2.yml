name: Deploy user front (EC2 + ALB)

on:
  push:
    branches: [ main, master ]
    paths:
      - "sigbang_user_front/**"
      - ".github/workflows/deploy-web-ec2.yml"
      - "sigbang_infra/**"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.image.outputs.image }}
    defaults:
      run:
        working-directory: sigbang_user_front
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - run: npm install --no-audit --no-fund
      - name: Build Docker image
        run: docker build -t ghcr.io/${{ github.repository_owner }}/sigbang_user_front:${{ github.sha }} .
      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Push Docker image
        run: |
          docker tag ghcr.io/${{ github.repository_owner }}/sigbang_user_front:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/sigbang_user_front:latest
          docker push ghcr.io/${{ github.repository_owner }}/sigbang_user_front:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/sigbang_user_front:latest
      - name: Set image output
        id: image
        run: echo "image=ghcr.io/${{ github.repository_owner }}/sigbang_user_front:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy-web-eic:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Resolve image to deploy
        id: resolve
        run: |
          IMAGE_OUT="${{ needs.build-and-push.outputs.image }}"
          if [ -z "$IMAGE_OUT" ]; then
            IMAGE_OUT="ghcr.io/${{ github.repository_owner }}/sigbang_user_front:${{ github.sha }}"
          fi
          echo "image=$IMAGE_OUT" >> $GITHUB_OUTPUT
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      - name: Deploy Web via EC2 Instance Connect (SSH)
        env:
          IMAGE: ${{ steps.resolve.outputs.image }}
          AWS_REGION: ap-northeast-2
          # ASG Name tag value for Web instances (from Terraform): var.web_project_name => "sigbang-web"
          TARGET_NAME_TAG: sigbang-web
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          CONTAINER_NAME: sigbang-web
          EXPOSE_PORT: "3000"
        run: |
          echo "Resolving target instance by tag Name=${TARGET_NAME_TAG}"
          IID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${TARGET_NAME_TAG}" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" --output text --region "$AWS_REGION")
          if [ -z "$IID" ]; then
            echo "No running instance found with Name=${TARGET_NAME_TAG}"
            exit 1
          fi
          AZ=$(aws ec2 describe-instances --instance-ids "$IID" \
            --query "Reservations[0].Instances[0].Placement.AvailabilityZone" --output text --region "$AWS_REGION")
          PUBIP=$(aws ec2 describe-instances --instance-ids "$IID" \
            --query "Reservations[0].Instances[0].PublicIpAddress" --output text --region "$AWS_REGION")
          echo "Target: $IID ($AZ) public-ip=$PUBIP"

          ssh-keygen -t ed25519 -N "" -f id_ed25519
          aws ec2-instance-connect send-ssh-public-key \
            --instance-id "$IID" --availability-zone "$AZ" \
            --instance-os-user ubuntu --ssh-public-key file://id_ed25519.pub \
            --region "$AWS_REGION" >/dev/null

          ssh -o StrictHostKeyChecking=no -i id_ed25519 ubuntu@"$PUBIP" bash -lc "
            set -euo pipefail
            IMAGE='${IMAGE}'
            EXPOSE_PORT=${EXPOSE_PORT}
            CONTAINER_NAME='${CONTAINER_NAME}'
            if echo \"\$IMAGE\" | grep -q '^ghcr.io/' && [ -n '${GHCR_USERNAME}' ] && [ -n '${GHCR_TOKEN}' ]; then
              echo '${GHCR_TOKEN}' | sudo docker login ghcr.io -u '${GHCR_USERNAME}' --password-stdin || true
            fi
            sudo docker pull \"\$IMAGE\"
            sudo docker ps --filter \"publish=\$EXPOSE_PORT\" -q | xargs -r sudo docker rm -f || true
            sudo docker rm -f \"\$CONTAINER_NAME\" || true
            [ -f /home/ubuntu/web.env ] && ENV_FILE_ARG='--env-file /home/ubuntu/web.env' || ENV_FILE_ARG=''
            sudo docker run --pull=always -d --name \"\$CONTAINER_NAME\" --restart=always \$ENV_FILE_ARG -p \$EXPOSE_PORT:3000 \"\$IMAGE\"
            sleep 3
            curl -fsS http://localhost:\$EXPOSE_PORT/robots.txt >/dev/null
            sudo docker ps -a | sed -n '1p;/sigbang-web/p'
            sudo docker inspect -f 'Image={{.Config.Image}} State={{.State.Status}}' sigbang-web
          "



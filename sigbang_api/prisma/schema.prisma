generator client {
  provider      = "prisma-client-js"
  output        = "../generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String               @id @default(uuid())
  email              String               @unique
  nickname           String
  profileImage       String?
  bio                String?
  status             UserStatus           @default(ACTIVE)
  deletedAt          DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  supabaseId         String?              @unique
  comments           Comment[]
  followingRelations Follow[]             @relation("UserFollowing")
  followerRelations  Follow[]             @relation("UserFollowers")
  likes              Like[]
  recipes            Recipe[]
  refreshTokens      RefreshToken[]
  reports            Report[]
  saves              Save[]
  lifecycleEvents    UserLifecycleEvent[]

  @@map("users")
}

model RefreshToken {
  id         String    @id @default(uuid())
  token      String    @unique
  userId     String
  expiresAt  DateTime
  isRevoked  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  deviceId   String?
  deviceName String?
  userAgent  String?
  ip         String?
  lastUsedAt DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Recipe {
  id             String              @id @default(uuid())
  title          String
  description    String
  ingredients    String
  altTitles      String[]            @default([])
  thumbnailImage String?
  linkTitle      String?
  linkUrl        String?
  cookingTime    Int?
  servings       Int?
  difficulty     Difficulty          @default(EASY)
  status         RecipeStatus        @default(DRAFT)
  isHidden       Boolean             @default(false)
  viewCount      Int                 @default(0)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  slug           String?             @unique
  authorId       String?
  comments       Comment[]
  editorialBoost EditorialBoost?
  likes          Like[]
  counter        RecipeCounter?
  events         RecipeEvent[]
  slugHistories  RecipeSlugHistory[]
  steps          RecipeStep[]
  tags           RecipeTag[]
  author         User?               @relation(fields: [authorId], references: [id])
  reports        Report[]
  saves          Save[]

  @@map("recipes")
}

model RecipeSlugHistory {
  id        String   @id @default(uuid())
  recipeId  String
  slug      String   @unique
  createdAt DateTime @default(now())
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_slug_history")
}

model RecipeCounter {
  id         String   @id @default(uuid())
  recipeId   String   @unique
  views7d    Int      @default(0)
  saves7d    Int      @default(0)
  likes7d    Int      @default(0)
  trendScore Decimal  @default(0) @db.Decimal(6, 4)
  updatedAt  DateTime @updatedAt
  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_counters")
}

model RecipeEvent {
  id         String   @id @default(uuid())
  recipeId   String
  type       String
  occurredAt DateTime @default(now())
  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_events")
}

model EditorialBoost {
  id        String    @id @default(uuid())
  recipeId  String    @unique
  boost     Decimal   @db.Decimal(3, 2)
  expiresAt DateTime?
  recipe    Recipe    @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("editorial_boosts")
}

model Tag {
  id        String      @id @default(uuid())
  name      String      @unique
  emoji     String?
  createdAt DateTime    @default(now())
  recipes   RecipeTag[]

  @@map("tags")
}

model RecipeTag {
  id       String @id @default(uuid())
  recipeId String
  tagId    String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([recipeId, tagId])
  @@map("recipe_tags")
}

model RecipeStep {
  id          String  @id @default(uuid())
  recipeId    String
  order       Int
  description String
  imageUrl    String?
  recipe      Recipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_steps")
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  isHidden  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  authorId  String?
  recipeId  String
  parentId  String?
  author    User?     @relation(fields: [authorId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  recipe    Recipe    @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  reports   Report[]

  @@map("comments")
}

model Like {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("likes")
}

model Save {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("saves")
}

model Follow {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  followerId  String
  followingId String
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followingId, createdAt])
  @@index([followerId, createdAt])
  @@map("follows")
}

model Report {
  id          String       @id @default(uuid())
  reason      ReportReason
  description String?
  status      ReportStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  reporterId  String?
  recipeId    String?
  commentId   String?
  comment     Comment?     @relation(fields: [commentId], references: [id], onDelete: Cascade)
  recipe      Recipe?      @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  reporter    User?        @relation(fields: [reporterId], references: [id])

  @@map("reports")
}

model AdminAction {
  id         String          @id @default(uuid())
  action     AdminActionType
  targetType String
  targetId   String
  reason     String?
  adminId    String
  createdAt  DateTime        @default(now())

  @@map("admin_actions")
}

model RecommendationEvent {
  id         String   @id @default(uuid())
  userId     String?
  anonId     String?
  sessionId  String?
  surface    String
  type       String
  recipeId   String
  position   Int?
  rankScore  Decimal? @db.Decimal(10, 4)
  expId      String?
  expVariant String?
  seed       String?
  cursor     String?
  createdAt  DateTime @default(now())

  @@index([surface, type, expId, expVariant, createdAt])
  @@index([userId, createdAt])
  @@map("recommendation_events")
}

model RecoModelRegistry {
  id        String   @id @default(uuid())
  name      String
  version   String
  isActive  Boolean  @default(false)
  meta      Json?
  createdAt DateTime @default(now())

  @@unique([name, version])
  @@map("reco_model_registry")
}

model UserRecommendations {
  id        String   @id @default(uuid())
  userId    String
  modelId   String
  items     Json
  updatedAt DateTime @updatedAt

  @@unique([userId, modelId])
  @@index([modelId, updatedAt])
  @@map("user_recommendations")
}

model UserLifecycleEvent {
  id         String             @id @default(uuid())
  userId     String
  type       LifecycleEventType
  actorType  ActorType
  actorId    String?
  prevStatus UserStatus?
  nextStatus UserStatus?
  reason     String?
  ip         String?
  userAgent  String?
  source     String?
  createdAt  DateTime           @default(now())
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("user_lifecycle_events")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum RecipeStatus {
  DRAFT
  PUBLISHED
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum ReportReason {
  SPAM
  INAPPROPRIATE_CONTENT
  HARASSMENT
  COPYRIGHT_VIOLATION
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum AdminActionType {
  HIDE_RECIPE
  HIDE_COMMENT
  BLOCK_USER
  UNBLOCK_USER
  DELETE_CONTENT
}

enum LifecycleEventType {
  SIGN_UP
  DELETE
  REACTIVATE
  SUSPEND
  UNSUSPEND
  LOGIN
  LOGOUT
  PASSWORD_RESET
  PROFILE_UPDATE
}

enum ActorType {
  USER
  ADMIN
  SYSTEM
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ì‚¬ìš©ì ëª¨ë¸
model User {
  id           String     @id @default(uuid())
  email        String     @unique
  nickname     String
  profileImage String?
  bio          String?
  status       UserStatus @default(ACTIVE)
  deletedAt    DateTime?
  emailVerifiedAt DateTime?
  lastPasswordChangedAt DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Supabase Authì™€ ì—°ë™ì„ ìœ„í•œ í•„ë“œ (OAuth ì‚¬ìš©ìëŠ” null ê°€ëŠ¥)
  supabaseId   String?    @unique
  
  // ê´€ê³„
  recipes      Recipe[]
  comments     Comment[]
  likes        Like[]
  saves        Save[]
  // íŒ”ë¡œìš° ê´€ê³„
  followingRelations Follow[] @relation("UserFollowing") // ë‚´ê°€ íŒ”ë¡œì‰í•˜ëŠ” ê´€ê³„ë“¤ (ë‚´ê°€ follower)
  followerRelations  Follow[] @relation("UserFollowers") // ë‚˜ë¥¼ íŒ”ë¡œìš°í•˜ëŠ” ê´€ê³„ë“¤ (ë‚´ê°€ following)
  reports      Report[] // ì‹ ê³ í•œ ë‚´ì—­
  refreshTokens RefreshToken[] // JWT ë¦¬í”„ë ˆì‹œ í† í°
  lifecycleEvents UserLifecycleEvent[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  
  @@map("users")
}

// JWT ë¦¬í”„ë ˆì‹œ í† í° ëª¨ë¸
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  // Device metadata
  deviceId   String?
  deviceName String?
  userAgent  String?
  ip         String?
  lastUsedAt DateTime?
  
  // ê´€ê³„
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
}

// ë ˆì‹œí”¼ ëª¨ë¸
model Recipe {
  id              String   @id @default(uuid())
  title           String
  description     String
  ingredients     String   // ë©€í‹°ë¼ì¸ ì¬ë£Œ (TEXT)
  altTitles       String[] @db.Text @default([]) // ë‹¤êµ­ì–´ ë³„ì¹­(ì´ˆê¸° ê¸€ë¡œë²Œ ëŒ€ì‘)
  thumbnailImage  String?  // ëŒ€í‘œ ì´ë¯¸ì§€ URL
  linkTitle       String?  // ê´€ë ¨ ë§í¬ ì œëª©
  linkUrl         String?  // ê´€ë ¨ ë§í¬ ì£¼ì†Œ
  cookingTime     Int?     // ì¡°ë¦¬ ì‹œê°„ (ë¶„)
  servings        Int?     // ëª‡ ì¸ë¶„
  difficulty      Difficulty @default(EASY)
  status          RecipeStatus @default(DRAFT) // ì„ì‹œì €ì¥ / ê³µê°œ êµ¬ë¶„
  isHidden        Boolean  @default(false) // ê´€ë¦¬ì ìˆ¨ê¹€ ì²˜ë¦¬
  viewCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // SEO-friendly slug (region/slug í˜•íƒœë¥¼ í¬í•¨í•  ìˆ˜ ìˆìŒ)
  slug            String?  @unique
  
  // ê´€ê³„
  authorId        String?
  author          User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
  comments        Comment[]
  likes           Like[]
  saves           Save[]
  reports         Report[]
  tags            RecipeTag[]
  steps           RecipeStep[]

  // Opposite sides
  counter         RecipeCounter?   // 1:1
  events          RecipeEvent[]    // 1:N
  editorialBoost  EditorialBoost?  // 1:1
  slugHistories   RecipeSlugHistory[]
  
  @@map("recipes")
}

// ê³¼ê±° ìŠ¬ëŸ¬ê·¸ ë³´ê´€(301 ë¦¬ë‹¤ì´ë ‰íŠ¸ ë“± ìš©ë„)
model RecipeSlugHistory {
  id        String   @id @default(uuid())
  recipeId  String
  slug      String   @unique
  createdAt DateTime @default(now())

  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_slug_history")
}

// ë ˆì‹œí”¼ íŠ¸ë Œë“œ ì¹´ìš´í„° (ìµœê·¼ 7ì¼ ì§‘ê³„)
model RecipeCounter {
  id         String   @id @default(uuid())
  recipeId   String   @unique
  views7d    Int      @default(0)
  saves7d    Int      @default(0)
  likes7d    Int      @default(0)
  trendScore Decimal  @default(0) @db.Decimal(6, 4)
  updatedAt  DateTime @updatedAt

  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_counters")
}

// ë ˆì‹œí”¼ ì´ë²¤íŠ¸ ë¡œê·¸ (view/save/like)
model RecipeEvent {
  id         String   @id @default(uuid())
  recipeId   String
  type       String   // 'view' | 'save' | 'like'
  occurredAt DateTime @default(now())

  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_events")
}

// ìš´ì˜ì ë¶€ìŠ¤íŒ… (ì¼ì‹œì  ë­í‚¹ ê°€ì¤‘ì¹˜)
model EditorialBoost {
  id        String   @id @default(uuid())
  recipeId  String   @unique
  boost     Decimal  @db.Decimal(3, 2) // 0.00~1.00
  expiresAt DateTime?

  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("editorial_boosts")
}

// ë ˆì‹œí”¼ íƒœê·¸ ëª¨ë¸
model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  emoji     String?  // ì´ëª¨ì§€ (ì˜ˆ: ğŸ‡¯ğŸ‡µ, ğŸ– ë“±)
  createdAt DateTime @default(now())
  
  // ê´€ê³„
  recipes   RecipeTag[]
  
  @@map("tags")
}

// ë ˆì‹œí”¼-íƒœê·¸ ì¤‘ê°„ í…Œì´ë¸”
model RecipeTag {
  id       String @id @default(uuid())
  recipeId String
  tagId    String
  
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([recipeId, tagId])
  @@map("recipe_tags")
}

// ë ˆì‹œí”¼ ë‹¨ê³„ ëª¨ë¸
model RecipeStep {
  id          String @id @default(uuid())
  recipeId    String
  order       Int    // ë‹¨ê³„ ìˆœì„œ
  description String // ì¡°ë¦¬ ì„¤ëª…
  imageUrl    String? // ì´ë¯¸ì§€ URL
  
  // ê´€ê³„
  recipe      Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  @@map("recipe_steps")
}

// ëŒ“ê¸€ ëª¨ë¸
model Comment {
  id        String   @id @default(uuid())
  content   String
  isHidden  Boolean  @default(false) // ê´€ë¦¬ì ìˆ¨ê¹€ ì²˜ë¦¬
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // ê´€ê³„
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  reports   Report[]
  
  // ëŒ€ëŒ“ê¸€ ê¸°ëŠ¥
  parentId  String?
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  
  @@map("comments")
}

// ì¢‹ì•„ìš” ëª¨ë¸
model Like {
  id       String @id @default(uuid())
  createdAt DateTime @default(now())
  
  // ê´€ê³„
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, recipeId]) // ì¤‘ë³µ ì¢‹ì•„ìš” ë°©ì§€
  @@map("likes")
}

// ì €ì¥(ìŠ¤í¬ë©) ëª¨ë¸
model Save {
  id       String @id @default(uuid())
  createdAt DateTime @default(now())
  
  // ê´€ê³„
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, recipeId]) // ì¤‘ë³µ ì €ì¥ ë°©ì§€
  @@map("saves")
}

// ì‚¬ìš©ì íŒ”ë¡œìš° ëª¨ë¸ (self-relation)
model Follow {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  
  // ê´€ê³„
  followerId  String
  followingId String
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
  @@index([followingId, createdAt])
  @@index([followerId, createdAt])
  @@map("follows")
}

// ì‹ ê³  ëª¨ë¸
model Report {
  id        String     @id @default(uuid())
  reason    ReportReason
  description String?
  status    ReportStatus @default(PENDING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  // ê´€ê³„ - ì‹ ê³ ì
  reporterId String?
  reporter   User?   @relation(fields: [reporterId], references: [id], onDelete: SetNull)
  
  // ì‹ ê³  ëŒ€ìƒ (ë ˆì‹œí”¼ ë˜ëŠ” ëŒ“ê¸€)
  recipeId   String?
  recipe     Recipe? @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  commentId  String?
  comment    Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  @@map("reports")
}

// ê´€ë¦¬ì ì•¡ì…˜ ë¡œê·¸
model AdminAction {
  id          String        @id @default(uuid())
  action      AdminActionType
  targetType  String        // 'recipe', 'comment', 'user'
  targetId    String
  reason      String?
  adminId     String        // ê´€ë¦¬ì ì‚¬ìš©ì ID
  createdAt   DateTime      @default(now())
  
  @@map("admin_actions")
}

// ê³„ì • ë¼ì´í”„ì‚¬ì´í´ ì´ë²¤íŠ¸ ë¡œê·¸
model UserLifecycleEvent {
  id         String              @id @default(uuid())
  userId     String
  type       LifecycleEventType
  actorType  ActorType
  actorId    String?
  prevStatus UserStatus?
  nextStatus UserStatus?
  reason     String?
  ip         String?
  userAgent  String?
  source     String?
  createdAt  DateTime           @default(now())

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("user_lifecycle_events")
}

// ì´ë©”ì¼ ì¸ì¦ í† í°
model EmailVerificationToken {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@map("email_verification_tokens")
}

// ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í† í°
model PasswordResetToken {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@map("password_reset_tokens")
}

// ì—´ê±°í˜•ë“¤
enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum RecipeStatus {
  DRAFT
  PUBLISHED
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum ReportReason {
  SPAM
  INAPPROPRIATE_CONTENT
  HARASSMENT
  COPYRIGHT_VIOLATION
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum AdminActionType {
  HIDE_RECIPE
  HIDE_COMMENT
  BLOCK_USER
  UNBLOCK_USER
  DELETE_CONTENT
}

enum LifecycleEventType {
  SIGN_UP
  DELETE
  REACTIVATE
  SUSPEND
  UNSUSPEND
  LOGIN
  LOGOUT
  PASSWORD_RESET
  PROFILE_UPDATE
}

enum ActorType {
  USER
  ADMIN
  SYSTEM
}
